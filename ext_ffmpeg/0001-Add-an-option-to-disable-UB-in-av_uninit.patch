From 360e8724ae626e3ddc0730f81f42da5ef0371135 Mon Sep 17 00:00:00 2001
From: Dmitry Kazakov <dimula73@gmail.com>
Date: Mon, 14 Apr 2025 12:56:53 +0200
Subject: [PATCH 1/4] Add an option to disable UB in av_uninit

Usage:
meson configure -Dno_uninit_ub=true
---
 libavutil/attributes.h | 4 +++-
 meson.build            | 5 +++++
 meson_options.txt      | 1 +
 3 files changed, 9 insertions(+), 1 deletion(-)

diff --git a/libavutil/attributes.h b/libavutil/attributes.h
index 04c615c952..3ab77d6eb8 100644
--- a/libavutil/attributes.h
+++ b/libavutil/attributes.h
@@ -150,7 +150,9 @@
 #   define av_alias
 #endif
 
-#if (defined(__GNUC__) || defined(__clang__)) && !defined(__INTEL_COMPILER)
+#if defined(DISABLE_AV_UNINIT_UB)
+#    define av_uninit(x) x=0
+#elif (defined(__GNUC__) || defined(__clang__)) && !defined(__INTEL_COMPILER)
 #    define av_uninit(x) x=x
 #else
 #    define av_uninit(x) x
diff --git a/meson.build b/meson.build
index 7714bcfed7..73e7ded5e1 100644
--- a/meson.build
+++ b/meson.build
@@ -549,6 +549,11 @@ types_list = [
   'struct_mfxConfigInterface',
 ]
 
+if get_option('no_uninit_ub')
+  add_global_arguments('-DDISABLE_AV_UNINIT_UB=1', language : 'c')
+  add_global_arguments('-DDISABLE_AV_UNINIT_UB=1', language : 'cpp')
+endif
+
 asm = get_option('asm')
 inline_asm = get_option('inline_asm')
 
diff --git a/meson_options.txt b/meson_options.txt
index ab5841285f..fd16f3c063 100644
--- a/meson_options.txt
+++ b/meson_options.txt
@@ -2485,3 +2485,4 @@ option('os2threads', type: 'feature', value: 'disabled', description: 'Enable OS
 option('tests', type : 'feature', value : 'auto', description : 'Build tests', yield : true)
 option('large_tests', type : 'feature', value : 'disabled')
 option('assert_level', type: 'integer', min: 0, max: 2, value: 0)
+option('no_uninit_ub', type: 'boolean', value: false, description: 'Disable UB in av_uninit optimization')
-- 
2.25.1

